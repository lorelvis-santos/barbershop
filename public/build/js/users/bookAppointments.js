let step=1,slider=null,currentEmployeeContainer=null,currentTimeContainer=null;const appointment={name:"",date:"",time:"",services:[],totalPrice:0,userId:"",employee:{id:"",name:"",phone:"",email:"",roleId:"",role:"",image:""}};function init(){showSection(step),checkPagination(step),tabs(),setPagination(),getServices(),getEmployees(),getUserId(),getDate(),getAvailableTimes(),showSummary()}function tabs(){document.querySelectorAll(".tabs button").forEach((e=>{e.addEventListener("click",(e=>{step=e.target.dataset.step,showSection(step),checkPagination(step)}))}))}function setPagination(){const e=document.querySelector("#back"),t=document.querySelector("#next");e.addEventListener("click",(e=>{const t=parseInt(document.querySelector("button.current").dataset.step);t>1&&(showSection(t-1),checkPagination(t-1)),scrollTo(0,document.body.scrollHeight)})),t.addEventListener("click",(e=>{const t=parseInt(document.querySelector("button.current").dataset.step);t<2&&(showSection(t+1),checkPagination(t+1)),document.querySelector("#step-2").scrollIntoView()}))}function checkPagination(e){const t=document.querySelector("#back"),n=document.querySelector("#next");1==e?(t.classList.add("hide"),n.classList.remove("hide")):2==e&&(t.classList.remove("hide"),n.classList.add("hide"))}function showSection(e){const t=document.querySelector(`button[data-step="${e}"]`),n=document.querySelector("button.current"),a=document.querySelector(`#step-${e}`),i=document.querySelector(".show");2==e&&showSummary(),n&&n.classList.remove("current"),t.classList.add("current"),i&&i.classList.remove("show"),a.classList.add("show")}function setEmployeesSlider(){slider=new KeenSlider("#employees",{mode:"snap",slides:{perView:1,spacing:20},dragSpeed:.8,breakpoints:{"(min-width: 768px)":{mode:"free-snap",slides:{perView:2,spacing:20}},"(min-width: 1400px)":{mode:"free-snap",slides:{perView:2,spacing:20}}}});const e=document.querySelector("#employees"),t=document.querySelectorAll(".arrow");e.addEventListener("mousedown",(t=>{e.classList.add("dragging")})),e.addEventListener("mouseup",(t=>{e.classList.remove("dragging")})),t.forEach((e=>{e.addEventListener("click",(t=>{"right-employee"===e.id?slider.next():slider.prev()}))}))}async function getEmployees(){try{const e="/api/employees",t=await fetch(e);showEmployees(await t.json())}catch(e){console.error(e)}}function showEmployees(e){e.forEach((e=>{const t=document.createElement("LI"),n=document.createElement("IMG"),a=document.createElement("P"),i=document.createElement("P"),{id:o,roleId:r,name:c,role:s,image:l}=e;n.classList.add("employee__image"),n.src=`/build/img/${l}`,a.classList.add("employee__name"),a.textContent=c,i.classList.add("employee__role"),i.textContent=s,t.classList.add("keen-slider__slide"),t.classList.add("employee"),t.dataset.id=o,t.dataset.roleId=r,t.appendChild(n),t.appendChild(a),t.appendChild(i),t.onclick=function(){employeeSelection(e,t)},document.querySelector("#employees").appendChild(t)})),setEmployeesSlider()}function employeeSelection(e,t){let n=!1;null===currentEmployeeContainer?(currentEmployeeContainer=t,currentEmployeeContainer.classList.add("selected"),appointment.employee=e,n=!0):currentEmployeeContainer!=t&&(currentEmployeeContainer.classList.remove("selected"),currentEmployeeContainer=t,currentEmployeeContainer.classList.add("selected"),currentEmployeeContainer.roleId!=appointment.employee.roleId&&(n=!0),appointment.employee=e),n&&(getServices(),appointment.services=[]),""!=appointment.time&&(appointment.time=""),getAvailableTimes()}async function getServices(){if(""===appointment.employee.id)return showAlert("error","Debes de seleccionar un empleado",".services-container",!1),!1;try{const e=`/api/services?id=${appointment.employee.roleId}`,t=await fetch(e);showServices(await t.json())}catch(e){console.error(e)}}function showServices(e){const t="#services",n=document.querySelector(t);clearContainer(t),alert=document.querySelector(".services-container .alert"),null!=alert&&alert.remove(),e.length>0?e.forEach((e=>{const{id:t,name:a,price:i}=e,o=document.createElement("DIV"),r=document.createElement("P"),c=document.createElement("P");r.classList.add("service__name"),r.textContent=a,c.classList.add("service__price"),c.textContent=`RD$${i}`,o.classList.add("service"),o.classList.add("clickable"),o.dataset.serviceId=t,o.appendChild(r),o.appendChild(c),o.onclick=function(){serviceSelection(e)},n.appendChild(o)})):showAlert("error","No hay ningún servicio asociado a ese rol",".services-container",!1)}function serviceSelection(e){const{id:t}=e,{services:n}=appointment,a=n.includes(e),i=document.querySelector(`[data-service-id="${t}"]`);i&&(a?deleteService(e):(appointment.services.length>0&&deleteService(appointment.services[0]),appointment.services=[e],i.classList.add("selected")))}function deleteService(e){const{id:t}=e,n=document.querySelector(`[data-service-id="${t}"]`);n&&appointment.services.includes(e)&&(appointment.services=appointment.services.filter((t=>t.id!=e.id)),n.classList.remove("selected"))}function getUserId(){appointment.userId=document.querySelector("#userId").value}function getDate(){const e=document.querySelector("#date");datepicker=flatpickr(e,{minDate:"today",maxDate:(new Date).fp_incr(21),altInput:!0,altFormat:"l, j \\de F \\de Y",dateFormat:"Y-m-d",disable:[function(e){return 2===e.getDay()}],locale:{firstDayOfWeek:1,weekdays:{shorthand:["Do","Lu","Ma","Mi","Ju","Vi","Sa"],longhand:["Domingo","Lunes","Martes","Miércoles","Jueves","Viernes","Sábado"]},months:{shorthand:["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Оct","Nov","Dic"],longhand:["Enero","Febrero","Мarzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"]}}}),e.addEventListener("input",(e=>{if(appointment.date=e.target.value,!appointment.employee.id)return clearContainer(".available-times"),showAlert("error","Debes de seleccionar un empleado",".available-times",!1),!1;getAvailableTimes()}))}function getTotalPrice(){if(0===appointment.services.length)return appointment.totalPrice=0,!1;let e=0;appointment.services.forEach((t=>{e+=parseFloat(t.price)})),appointment.totalPrice=e.toFixed(2)}async function getAvailableTimes(){if(""===appointment.date)return clearContainer(".available-times"),showAlert("error","Selecciona un empleado y luego la fecha",".available-times",!1),!1;try{const e=`/api/employees/availabletimes?id=${appointment.employee.id}&date=${appointment.date}`,t=await fetch(e);showAvailableTimes(await t.json())}catch(e){console.error(e)}}function showAvailableTimes(e){const t=".available-times";if(clearContainer(t),!e)return showAlert("error","No hay horarios disponibles para ese día",t,!1),!1;const n=document.querySelector(t);e.forEach((e=>{const t=document.createElement("LI");t.dataset.id=e.id,t.textContent=to12hr(e.time),t.classList.add("available-time"),t.onclick=function(){timeSelection(e,t)},n.appendChild(t)}))}function timeSelection(e,t){null===currentTimeContainer?(currentTimeContainer=t,currentTimeContainer.classList.add("selected"),appointment.time=e):currentTimeContainer!=t&&(currentTimeContainer.classList.remove("selected"),currentTimeContainer=t,currentTimeContainer.classList.add("selected"),appointment.time=e)}function showSummary(){clearContainer(".summary");const e=document.querySelector(".summary");if(0===appointment.services.length)return showAlert("error","Debes seleccionar mínimo un servicio",".summary",!1),!1;if(""===appointment.date||""===appointment.time)return showAlert("error","Debes seleccionar una fecha y una hora",".summary",!1),!1;const{date:t,time:n,services:a,employee:i}=appointment,o=formatDate(t),r=document.createElement("H2"),c=document.createElement("H3"),s=document.createElement("FORM"),l=document.createElement("H3"),d=document.createElement("DIV"),m=document.createElement("DIV"),p=document.createElement("BUTTON"),u=document.createElement("DIV"),h=document.createElement("P"),y=document.createElement("SPAN");r.textContent="Resumen";const v=[{id:"established-employee-name",label:"Te atenderá",inputInfo:i.name},{id:"established-date",label:"Fecha de la cita",inputInfo:capitalizeFirstLetter(o)},{id:"established-hour",label:"Hora establecida",inputInfo:to12hr(n.time)}];c.textContent="Información de la cita",c.classList.add("text-center"),s.classList.add("form"),v.forEach((e=>{const t=document.createElement("DIV"),n=document.createElement("LABEL"),a=document.createElement("INPUT");t.classList.add("field"),n.textContent=e.label,n.setAttribute("for",e.id),a.setAttribute("type","text"),a.setAttribute("id",e.id),a.setAttribute("value",e.inputInfo),a.setAttribute("disabled",!0),t.appendChild(n),t.appendChild(a),s.appendChild(t)})),l.textContent="Servicios seleccionados",l.classList.add("text-center"),a.forEach((e=>{const t=document.createElement("DIV"),n=document.createElement("P"),a=document.createElement("DIV"),i=document.createElement("DIV"),o=document.createElement("P"),r=deleteIconSVG(),{id:c,name:s,price:l}=e;n.textContent=s,n.classList.add("service__name"),o.textContent=`RD$${l}`,o.classList.add("service__price"),a.appendChild(n),a.appendChild(o),r.classList.add("clickable"),r.onclick=function(){if(deleteService(e),t.remove(),0===appointment.services.length)return showAlert("error","Debes seleccionar mínimo un servicio",".summary .services-container",!1),document.querySelector(".total-price").remove(),document.querySelector("#book-button").remove(),!1;getTotalPrice(),document.querySelector(".total-price span").textContent="RD$"+appointment.totalPrice},i.appendChild(r),i.classList.add("service__right"),t.appendChild(a),t.appendChild(i),t.classList.add("service-container"),d.appendChild(t),d.classList.add("services-container")})),getTotalPrice(),y.textContent="RD$"+appointment.totalPrice,h.textContent="Total a pagar: ",h.classList.add("total-price"),h.append(y),u.appendChild(h),u.classList.add("total-price-container"),p.classList.add("button"),p.textContent="Reservar",p.id="book-button",p.onclick=arrangeAppointment,m.classList.add("place-right"),m.appendChild(p),e.appendChild(r),e.appendChild(c),e.appendChild(s),e.appendChild(l),e.appendChild(d),e.appendChild(u),e.appendChild(m)}async function arrangeAppointment(){const e=appointment.services.map((e=>e.id)),{date:t,totalPrice:n,time:a,userId:i,employee:o}=appointment,r=new FormData;r.append("date",t),r.append("totalPrice",n),r.append("timeId",a.id),r.append("services",e),r.append("userId",i),r.append("employeeId",o.id);try{await fetch("/api/appointments",{method:"POST",body:r});Swal.fire({icon:"success",title:"Cita reservada",text:"Tu cita ha sido reservada correctamente!"}).then((()=>window.location.reload()))}catch(e){Swal.fire({icon:"error",title:"Oops...",text:"Ha ocurrido un error!",footer:`${e}`})}}document.addEventListener("DOMContentLoaded",(function(){init()}));