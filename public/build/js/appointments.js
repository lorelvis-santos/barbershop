let appointmentsList={today:[],tomorrow:[],postTomorrow:[],week:[],nextWeek:[],others:[]};const containerSelector=".appointments";function getInfo(){return document.querySelector("#info #id").value}async function getBookedAppointments(e,t,n=!1){if(id=getInfo(),!id)return!1;try{const a=`/api/${e}/bookedappointments?id=${id}&field=${t}`,o=await fetch(a),i=await o.json();if(0===i.length)return!1;return orderAppointmentsByDate(groupAppointments(i),n),!0}catch(e){return console.error(e),!1}}function orderAppointmentsByDate(e,t=!1){const n=new Date,a=new Date(n.getFullYear(),n.getMonth(),n.getDate()+1),o=new Date(a.getFullYear(),a.getMonth(),a.getDate()+1),i=n.GetLastDayOfWeek(),s=new Date(i.getFullYear(),i.getMonth(),i.getDate()+1),c=s.GetLastDayOfWeek();e.forEach((e=>{const{date:t}=e;t===getDateISO(n)?appointmentsList.today.push(e):t===getDateISO(a)?appointmentsList.tomorrow.push(e):t===getDateISO(o)?appointmentsList.postTomorrow.push(e):t>getDateISO(o)&&t<=getDateISO(i)?appointmentsList.week.push(e):t>=getDateISO(s)&&t<=getDateISO(c)?appointmentsList.nextWeek.push(e):appointmentsList.others.push(e)})),showAppointments(t)}function groupAppointments(e){const t={};return e.forEach((e=>{const{id:n,date:a,time:o,totalPrice:i,customerId:s,customerName:c,customerEmail:p,customerPhone:d,employeeId:r,employeeName:l,employeeRoleId:m,employeeRoleName:u,serviceId:h,serviceName:C,servicePrice:E}=e;t[n]||(t[n]={id:n,date:a,time:o,totalPrice:i,customer:{id:s,name:c,email:p,phone:d},employee:{id:r,name:l,roleId:m,roleName:u},services:[]}),t[n].services.push({id:h,name:C,price:E})})),Object.values(t).sort(((e,t)=>{const n=e.time.split(":").map(Number),a=t.time.split(":").map(Number);return n[0]-a[0]||n[1]-a[1]}))}function showAppointments(e=!1){const{today:t,tomorrow:n,postTomorrow:a,week:o,nextWeek:i,others:s}=appointmentsList;t.length>0&&listAppointments("Hoy",t,e),n.length>0&&listAppointments("Mañana",n,e),a.length>0&&listAppointments("Pasado mañana",a,e),o.length>0&&listAppointments("Esta semana",o,e),i.length>0&&listAppointments("Próxima semana",i,e),s.length>0&&listAppointments("Otras fechas",s,e)}function listAppointments(e,t,n=!1){const a=document.querySelector(containerSelector);if(!a)return!1;const o=document.createElement("DIV"),i=document.createElement("H3"),s=document.createElement("UL");t.forEach((e=>{const t=document.createElement("LI"),a=document.createElement("DIV"),o=document.createElement("DIV"),i=document.createElement("DIV"),c=dateIconSVG(),p=document.createElement("P"),d=document.createElement("DIV"),r=timeIconSVG(),l=document.createElement("P"),m=document.createElement("H4"),u=document.createElement("UL"),h=document.createElement("DIV"),C=document.createElement("P"),E=document.createElement("DIV"),L=document.createElement("BUTTON"),f=deleteIconWhiteSVG();p.textContent=capitalizeFirstLetter(formatDate(e.date)),i.appendChild(c),i.appendChild(p),i.classList.add("appointment__date"),l.textContent=to12hr(e.time),d.appendChild(r),d.appendChild(l),d.classList.add("appointment__time"),o.appendChild(i),o.appendChild(d),o.classList.add("appointment__day"),a.appendChild(o);const g=document.createElement("DIV"),D=userIconSVG(),I=document.createElement("P");if(I.textContent=n?e.customer.name:e.employee.name,g.appendChild(D),g.appendChild(I),g.classList.add("appointment__customer"),a.appendChild(g),a.classList.add("appointment__info"),m.textContent="Servicios solicitados",u.classList.add("appointment__services"),e.services.forEach((e=>{const t=document.createElement("LI"),n=document.createElement("P"),a=document.createElement("P");n.textContent=e.name,n.classList.add("appointment__service__name"),a.textContent="RD$"+e.price,a.classList.add("appointment__service__price"),t.appendChild(n),t.appendChild(a),t.classList.add("appointment__service"),u.appendChild(t)})),C.innerHTML=`Total a pagar: <span>RD$${e.totalPrice}</span>`,C.classList.add("total-price"),h.appendChild(C),h.classList.add("appointment__total-price"),n){const t=document.createElement("BUTTON"),n=whatsappIconSVG(),a=document.createElement("BUTTON"),o=callIconSVG();t.appendChild(n),t.attributes.type="button",t.classList.add("clickable"),t.id="message-customer",t.addEventListener("click",(function(){messageCustomer(e.customer.phone)})),a.appendChild(o),a.attributes.type="button",a.classList.add("clickable"),a.id="call-customer",a.addEventListener("click",(function(){callCustomer(e.customer.phone)})),E.appendChild(t),E.appendChild(a)}L.appendChild(f),L.attributes.type="button",L.classList.add("clickable"),L.id="delete-appointment",L.addEventListener("click",(function(){deleteAppointment(e,t,n)})),E.appendChild(L),E.classList.add("appointment__actions"),t.appendChild(a),t.appendChild(m),t.appendChild(u),t.appendChild(h),t.appendChild(E),t.classList.add("appointment"),s.appendChild(t)})),i.textContent=e,s.classList.add("booked-appointments"),o.appendChild(i),o.appendChild(s),a.appendChild(o)}function messageCustomer(e){const t="1"===e.charAt(0)?e:"1"+e;window.location.href="https://wa.me/"+t}function callCustomer(e){const t="1"===e.charAt(0)?e:"+1"+e;window.location.href="tel:"+t}async function deleteAppointment(e,t,n=!1){if(!e.id)return!1;try{const a="/api/appointments",o=new FormData;o.append("method","DELETE"),o.append("id",e.id);await fetch(a,{method:"POST",body:o});Swal.fire({icon:"success",title:"Cita eliminada",text:"La cita ha sido eliminada correctamente!"});const i=document.querySelector(containerSelector),s=t.parentElement,c=s.parentElement;if(1===s.childElementCount?c.remove():t.remove(),0===i.childElementCount&&(showAlert("error","No hay citas agendadas",".app",!1),!n)){const e=document.createElement("DIV"),t=document.createElement("A");t.textContent="Agendar cita",t.href="/cliente/agendar-cita",t.classList.add("button"),t.classList.add("button-responsive"),e.classList.add("place-center"),e.appendChild(t),document.querySelector(".app").appendChild(e)}}catch(e){Swal.fire({icon:"error",title:"Oops...",text:"Ha ocurrido un error!",footer:`${e}`})}}